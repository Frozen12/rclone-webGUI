<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rclone WebGUI</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <style>
        body {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .container {
            max-width: 960px;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out;
        }
        .input-field {
            @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200;
        }
        .textarea-field {
            @apply shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200 h-48;
        }
        .log-output {
            @apply bg-gray-800 text-green-400 p-3 rounded-md overflow-auto h-64 font-mono text-sm;
            white-space: pre-wrap; /* Preserve whitespace and wrap long lines */
        }
        .terminal-output {
             @apply bg-gray-900 text-lime-400 p-3 rounded-md overflow-auto h-96 font-mono text-sm;
             white-space: pre-wrap;
        }
        .status-message.success {
            @apply bg-green-500 text-white p-2 rounded;
        }
        .status-message.error {
            @apply bg-red-500 text-white p-2 rounded;
        }
        /* Hidden class for toggling sections */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="p-6">
    <div class="container mx-auto bg-gray-800 p-8 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Rclone WebGUI</h1>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="setupBtn" class="btn-primary px-6 py-3">Setup</button>
            <button id="terminalBtn" class="btn-primary px-6 py-3">Web Terminal</button>
        </div>

        <div id="setupSection" class="hidden bg-gray-700 p-6 rounded-lg mb-8 shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-blue-300">Rclone Setup</h2>

            <div class="mb-6 border-b border-gray-600 pb-6">
                <h3 class="text-xl font-medium mb-3 text-white">Upload rclone.conf</h3>
                <input type="file" id="rcloneConfFile" class="block w-full text-sm text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2">
                <button onclick="uploadRcloneConf()" class="btn-secondary">Upload rclone.conf</button>
            </div>

            <div class="mb-4">
                <h3 class="text-xl font-medium mb-3 text-white">Upload Service Account ZIP</h3>
                <input type="file" id="saZipFile" class="block w-full text-sm text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2">
                <button onclick="uploadSaZip()" class="btn-secondary">Upload SA ZIP</button>
            </div>
        </div>

        <div id="terminalSection" class="hidden bg-gray-700 p-6 rounded-lg mb-8 shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-blue-300">Web Terminal</h2>
            <div class="mb-4">
                <label for="terminalCommandInput" class="block text-white text-sm font-bold mb-2">Command:</label>
                <input type="text" id="terminalCommandInput" class="input-field mb-2" placeholder="e.g., ls -la /app">
                <button onclick="executeTerminalCommand()" class="btn-primary">Execute Command</button>
            </div>
            <div class="mb-4">
                <label for="terminalOutput" class="block text-white text-sm font-bold mb-2">Output:</label>
                <pre id="terminalOutput" class="terminal-output"></pre>
            </div>
            <button onclick="clearTerminalOutput()" class="btn-secondary">Clear Output</button>
        </div>


        <div class="bg-gray-700 p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-blue-300">Start Rclone Transfer</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="source" class="block text-white text-sm font-bold mb-2">Source:</label>
                    <input type="text" id="source" class="input-field" placeholder="remote:path/to/source">
                </div>
                <div>
                    <label for="destination" class="block text-white text-sm font-bold mb-2">Destination:</label>
                    <input type="text" id="destination" class="input-field" placeholder="remote:path/to/destination">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="mode" class="block text-white text-sm font-bold mb-2">Mode:</label>
                    <select id="mode" class="input-field">
                        <option value="copy">Copy</option>
                        <option value="move">Move</option>
                        <option value="sync">Sync</option>
                        <option value="delete">Delete</option>
                        <option value="lsd">List Directories (lsd)</option>
                        <option value="ls">List Files (ls)</option>
                    </select>
                </div>
                <div>
                    <label for="transfers" class="block text-white text-sm font-bold mb-2">Transfers:</label>
                    <input type="number" id="transfers" class="input-field" value="4" min="1" max="128">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="checkers" class="block text-white text-sm font-bold mb-2">Checkers:</label>
                    <input type="number" id="checkers" class="input-field" value="8" min="1" max="128">
                </div>
                <div>
                    <label for="buffer_size" class="block text-white text-sm font-bold mb-2">Buffer Size (MB):</label>
                    <input type="number" id="buffer_size" class="input-field" value="128" min="1" max="1024">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="order" class="block text-white text-sm font-bold mb-2">Order By:</label>
                    <select id="order" class="input-field">
                        <option value="name">Name</option>
                        <option value="size">Size</option>
                        <option value="modtime">Modification Time</option>
                    </select>
                </div>
                <div>
                    <label for="loglevel" class="block text-white text-sm font-bold mb-2">Log Level:</label>
                    <select id="loglevel" class="input-field">
                        <option value="Info">Info</option>
                        <option value="ERROR">Error</option>
                        <option value="DEBUG">Debug</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <label for="additional_flags" class="block text-white text-sm font-bold mb-2">Additional Flags:</label>
                <input type="text" id="additional_flags" class="input-field" placeholder="e.g., --drive-server-side-across-configs">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="flex items-center">
                    <input type="checkbox" id="use_drive_trash" class="form-checkbox h-5 w-5 text-blue-600">
                    <label for="use_drive_trash" class="ml-2 text-white">Use Drive Trash</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="service_account" class="form-checkbox h-5 w-5 text-blue-600">
                    <label for="service_account" class="ml-2 text-white">Use Service Account</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="dry_run" class="form-checkbox h-5 w-5 text-blue-600">
                    <label for="dry_run" class="ml-2 text-white">Dry Run</label>
                </div>
            </div>

            <button onclick="startRcloneTransfer()" class="btn-primary w-full py-3 mb-4">Start Rclone Transfer</button>

            <div class="mb-4">
                <label for="output" class="block text-white text-sm font-bold mb-2">Rclone Output:</label>
                <pre id="output" class="log-output"></pre>
            </div>

            <button onclick="downloadLogs()" class="btn-secondary w-full py-3">Download Logs</button>
        </div>
    </div>

    <script>
        const outputElement = document.getElementById('output');
        const terminalOutputElement = document.getElementById('terminalOutput');
        const setupBtn = document.getElementById('setupBtn');
        const setupSection = document.getElementById('setupSection');
        const terminalBtn = document.getElementById('terminalBtn');
        const terminalSection = document.getElementById('terminalSection');
        const terminalCommandInput = document.getElementById('terminalCommandInput');

        let terminalPollingInterval;

        // Toggle Setup Section Visibility
        setupBtn.addEventListener('click', () => {
            setupSection.classList.toggle('hidden');
            terminalSection.classList.add('hidden'); // Hide terminal if setup is opened
        });

        // Toggle Web Terminal Section Visibility
        terminalBtn.addEventListener('click', () => {
            terminalSection.classList.toggle('hidden');
            setupSection.classList.add('hidden'); // Hide setup if terminal is opened
            if (!terminalSection.classList.contains('hidden')) {
                // Start polling for terminal output when visible
                if (!terminalPollingInterval) {
                    terminalPollingInterval = setInterval(getTerminalOutput, 1000); // Poll every 1 second
                }
                terminalCommandInput.focus(); // Focus input field
            } else {
                // Stop polling when hidden
                clearInterval(terminalPollingInterval);
                terminalPollingInterval = null;
            }
        });


        // --- Rclone Uploads & Transfer ---
        async function uploadFile(fileInputId, endpoint) {
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            outputElement.textContent = `Uploading ${file.name}...`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.status === 'success') {
                    outputElement.textContent = data.message;
                    outputElement.classList.remove('text-red-400');
                    outputElement.classList.add('text-green-400');
                } else {
                    outputElement.textContent = `Error: ${data.message}`;
                    outputElement.classList.remove('text-green-400');
                    outputElement.classList.add('text-red-400');
                }
            } catch (error) {
                outputElement.textContent = `Network error: ${error}`;
                outputElement.classList.remove('text-green-400');
                outputElement.classList.add('text-red-400');
            }
            fileInput.value = ''; // Clear file input
        }

        function uploadRcloneConf() {
            uploadFile('rcloneConfFile', '/upload-rclone-conf');
        }

        function uploadSaZip() {
            uploadFile('saZipFile', '/upload-sa-zip');
        }

        async function startRcloneTransfer() {
            outputElement.textContent = 'Starting Rclone transfer...';
            outputElement.classList.remove('text-red-400');
            outputElement.classList.add('text-green-400');

            const payload = {
                source: document.getElementById('source').value,
                destination: document.getElementById('destination').value,
                mode: document.getElementById('mode').value,
                transfers: document.getElementById('transfers').value,
                checkers: document.getElementById('checkers').value,
                buffer_size: document.getElementById('buffer_size').value,
                order: document.getElementById('order').value,
                loglevel: document.getElementById('loglevel').value,
                additional_flags: document.getElementById('additional_flags').value,
                use_drive_trash: document.getElementById('use_drive_trash').checked,
                service_account: document.getElementById('service_account').checked,
                dry_run: document.getElementById('dry_run').checked
            };

            const response = await fetch('/execute-rclone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                let lastNewlineIndex = buffer.lastIndexOf('\n');

                while (lastNewlineIndex !== -1) {
                    const line = buffer.substring(0, lastNewlineIndex);
                    buffer = buffer.substring(lastNewlineIndex + 1);
                    
                    try {
                        const data = JSON.parse(line);
                        if (data.status === 'progress') {
                            outputElement.textContent = data.output; // Display buffered output
                            outputElement.scrollTop = outputElement.scrollHeight; // Scroll to bottom
                        } else {
                            outputElement.textContent += `\n${data.message}`;
                            outputElement.scrollTop = outputElement.scrollHeight;
                            if (data.status === 'error') {
                                outputElement.classList.remove('text-green-400');
                                outputElement.classList.add('text-red-400');
                            } else if (data.status === 'complete') {
                                outputElement.classList.remove('text-red-400');
                                outputElement.classList.add('text-green-400');
                            }
                        }
                    } catch (e) {
                        // Handle incomplete JSON or non-JSON lines
                        console.error("Failed to parse JSON line:", line, e);
                    }
                    lastNewlineIndex = buffer.lastIndexOf('\n');
                }
            }
        }

        function downloadLogs() {
            window.location.href = '/download-logs';
        }

        // --- Web Terminal Functions ---
        async function executeTerminalCommand() {
            const command = terminalCommandInput.value.trim();
            if (!command) {
                terminalOutputElement.textContent += "\nNo command entered.\n";
                return;
            }

            terminalOutputElement.textContent += `\n$ ${command}\n`; // Display command typed
            terminalOutputElement.scrollTop = terminalOutputElement.scrollHeight;

            try {
                const response = await fetch('/execute_terminal_command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });
                const data = await response.json();
                if (data.status === 'error') {
                    terminalOutputElement.textContent += `ERROR: ${data.output}\n`;
                }
                // Output will be updated by polling getTerminalOutput()
                terminalCommandInput.value = ''; // Clear input after sending command
            } catch (error) {
                terminalOutputElement.textContent += `\nNetwork error: ${error}\n`;
            }
            terminalOutputElement.scrollTop = terminalOutputElement.scrollHeight;
        }

        async function getTerminalOutput() {
            try {
                const response = await fetch('/get_terminal_output');
                const data = await response.json();
                if (data.output) {
                    terminalOutputElement.textContent += data.output;
                    terminalOutputElement.scrollTop = terminalOutputElement.scrollHeight;
                }
            } catch (error) {
                console.error("Error polling terminal output:", error);
            }
        }

        function clearTerminalOutput() {
            terminalOutputElement.textContent = '';
        }

        // Handle Enter key in terminal input
        terminalCommandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission
                executeTerminalCommand();
            }
        });

    </script>
</body>
</html>
